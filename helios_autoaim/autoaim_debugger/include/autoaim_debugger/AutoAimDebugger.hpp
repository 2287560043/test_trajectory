// created by liuhan on 2023/12/28
// Submodule of HeliosRobotSystem
// for more see document: https://swjtuhelios.feishu.cn/docx/MfCsdfRxkoYk3oxWaazcfUpTnih?from=from_copylink
/*
 * ██   ██ ███████ ██      ██  ██████  ███████
 * ██   ██ ██      ██      ██ ██    ██ ██
 * ███████ █████   ██      ██ ██    ██ ███████
 * ██   ██ ██      ██      ██ ██    ██      ██
 * ██   ██ ███████ ███████ ██  ██████  ███████
 */
#pragma once

#include <angles/angles.h>
#include <cv_bridge/cv_bridge.h>
#include <message_filters/subscriber.h>
#include <message_filters/sync_policies/approximate_time.h>
#include <message_filters/synchronizer.h>
#include <tf2/LinearMath/Matrix3x3.h>
#include <tf2/LinearMath/Quaternion.h>
#include <tf2/convert.h>
#include <tf2_ros/buffer.h>
#include <tf2_ros/create_timer_ros.h>
#include <tf2_ros/message_filter.h>
#include <tf2_ros/transform_listener.h>

#include <Eigen/Core>
#include <Eigen/Dense>
#include <autoaim_interfaces/msg/armors.hpp>
#include <autoaim_interfaces/msg/detail/receive_data__struct.hpp>
#include <autoaim_interfaces/msg/detail/target__struct.hpp>
#include <autoaim_interfaces/msg/receive_data.hpp>
#include <autoaim_interfaces/msg/target.hpp>
#include <geometry_msgs/msg/detail/transform_stamped__struct.hpp>
#include <geometry_msgs/msg/transform_stamped.hpp>
#include <image_transport/image_transport.hpp>
#include <memory>
#include <opencv2/calib3d.hpp>
#include <opencv2/core.hpp>
#include <opencv2/core/quaternion.hpp>
#include <opencv2/highgui.hpp>
#include <opencv2/imgproc.hpp>
#include <queue>
#include <rclcpp/rclcpp.hpp>
#include <sensor_msgs/msg/camera_info.hpp>
#include <sensor_msgs/msg/detail/image__struct.hpp>
#include <sensor_msgs/msg/image.hpp>
#include <tf2_geometry_msgs/tf2_geometry_msgs.hpp>
#include <vector>
#include <visualization_msgs/msg/marker.hpp>
#include <visualization_msgs/msg/marker_array.hpp>

#include "BulletModel.hpp"

// auto generated by ros2 generate_parameter_library
// https://github.com/PickNikRobotics/generate_parameter_library
#include "autoaim_debugger_parameters.hpp"

namespace helios_cv
{

using Params = autoaim_debugger::Params;
using ParamListener = autoaim_debugger::ParamListener;
using tf2_filter = tf2_ros::MessageFilter<sensor_msgs::msg::Image>;

class AutoAimDebugger : public rclcpp::Node
{
public:
  AutoAimDebugger(const rclcpp::NodeOptions& options);

  ~AutoAimDebugger() = default;

private:
  void init_object_points();

  void image_callback(sensor_msgs::msg::Image::SharedPtr msg,
                      autoaim_interfaces::msg::Target::SharedPtr target_msg,
                      autoaim_interfaces::msg::Armors::SharedPtr armors_msg);

  void no_hardware_callback(sensor_msgs::msg::Image::SharedPtr msg,
                            autoaim_interfaces::msg::Target::SharedPtr target_msg,
                            autoaim_interfaces::msg::Armors::SharedPtr armors_msg);

  std::string node_namespace_;
  std::string frame_namespace_;

  // publishers and subscribers
  rclcpp::Subscription<sensor_msgs::msg::CameraInfo>::SharedPtr camera_info_sub_;

  message_filters::Subscriber<autoaim_interfaces::msg::Target> target_sub_;
  message_filters::Subscriber<autoaim_interfaces::msg::Armors> armors_sub_;

  rclcpp::Subscription<autoaim_interfaces::msg::ReceiveData>::SharedPtr receive_data_sub_;
  autoaim_interfaces::msg::ReceiveData receive_data_;

  image_transport::Publisher image_pub_;  // 完整调试图像（包含跟踪、预测、子弹轨迹等）
  image_transport::Publisher detection_image_pub_;  // 仅检测相关图像（检测角点+重投影）

  // tf2 utilities
  std::shared_ptr<tf2_ros::Buffer> tf2_buffer_;
  std::shared_ptr<tf2_ros::TransformListener> tf2_listener_;
  message_filters::Subscriber<sensor_msgs::msg::Image> image_sub_;

  using NormalPolicy =
      message_filters::sync_policies::ApproximateTime<sensor_msgs::msg::Image,
                                                       autoaim_interfaces::msg::Target,
                                                       autoaim_interfaces::msg::Armors>;

  using NoHardwarePolicy =
      message_filters::sync_policies::ApproximateTime<sensor_msgs::msg::Image,
                                                       autoaim_interfaces::msg::Target,
                                                       autoaim_interfaces::msg::Armors>;

  std::shared_ptr<message_filters::Synchronizer<NormalPolicy>> sync_;
  std::shared_ptr<message_filters::Synchronizer<NoHardwarePolicy>> no_hardware_sync_;

  geometry_msgs::msg::TransformStamped cam2odom_;
  geometry_msgs::msg::TransformStamped odom2cam_;
  geometry_msgs::msg::TransformStamped gimbal2odom_;

  void draw_predicted_points();

  // camera info
  cv::Point image_center_;
  cv::Mat camera_matrix_;
  cv::Mat distortion_coefficients_;

  // project infos
  std::vector<cv::Point3f> armor_object_points_;
  std::vector<cv::Point3f> energy_object_points_;
  std::vector<cv::Point3f> bullet_object_points_;

  std::vector<geometry_msgs::msg::Pose> target_pose_ros_;
  std::vector<cv::Mat> target_tvecs_;
  std::vector<cv::Quatd> target_rvecs_;
  void caculate_target(autoaim_interfaces::msg::Target::SharedPtr target_msg);

  void draw_detected_armors(autoaim_interfaces::msg::Armors::SharedPtr armors_msg, cv::Mat& target_image);

  std::shared_ptr<BulletModel> bullet_model_;
  std::vector<cv::Mat> bullet_tvecs_;

  rclcpp::Time last_time_;
  void caculate_bullets(autoaim_interfaces::msg::Target::SharedPtr target_msg);

  // raw image
  cv::Mat raw_image_;  // 完整调试图像
  cv::Mat detection_image_;  // 仅检测图像

  // params
  Params params_;
  std::shared_ptr<ParamListener> param_listener_;
  rclcpp::node_interfaces::OnSetParametersCallbackHandle::SharedPtr param_callback_;

  // logger
  rclcpp::Logger logger_ = rclcpp::get_logger("AutoAimDebugger");
};

}  // namespace helios_cv