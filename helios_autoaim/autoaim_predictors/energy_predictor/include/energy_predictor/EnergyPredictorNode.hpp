// created by liuhan on 2023/10/29
// Submodule of HeliosRobotSystem
// for more see document: https://swjtuhelios.feishu.cn/docx/MfCsdfRxkoYk3oxWaazcfUpTnih?from=from_copylink
/*
 * ██   ██ ███████ ██      ██  ██████  ███████
 * ██   ██ ██      ██      ██ ██    ██ ██
 * ███████ █████   ██      ██ ██    ██ ███████
 * ██   ██ ██      ██      ██ ██    ██      ██
 * ██   ██ ███████ ███████ ██  ██████  ███████
 */
#pragma once

// ros
#include <angles/angles.h>

#include <autoaim_interfaces/msg/detail/debug_energy_vel__struct.hpp>
#include <rclcpp/publisher.hpp>
#include <rclcpp/rclcpp.hpp>

// tf2
#include <message_filters/subscriber.h>
#include <tf2/LinearMath/Matrix3x3.h>
#include <tf2/LinearMath/Quaternion.h>
#include <tf2/convert.h>
#include <tf2_ros/buffer.h>
#include <tf2_ros/create_timer_ros.h>
#include <tf2_ros/message_filter.h>
#include <tf2_ros/transform_listener.h>

#include <rclcpp/service.hpp>
#include <rclcpp/subscription.hpp>
#include <tf2_geometry_msgs/tf2_geometry_msgs.hpp>

// interfaces
#include <geometry_msgs/msg/point.hpp>
#include <geometry_msgs/msg/pose_stamped.hpp>
#include <geometry_msgs/msg/quaternion.hpp>
#include <geometry_msgs/msg/transform_stamped.hpp>
#include <sensor_msgs/msg/camera_info.hpp>
#include <std_srvs/srv/trigger.hpp>
#include <visualization_msgs/msg/marker.hpp>
#include <visualization_msgs/msg/marker_array.hpp>

#include "autoaim_interfaces/msg/armors.hpp"
#include "autoaim_interfaces/msg/debug_energy_vel.hpp"
#include "autoaim_interfaces/msg/omega.hpp"
#include "autoaim_interfaces/msg/target.hpp"
#include "autoaim_interfaces/msg/receive_data.hpp"
// custom
#include <Eigen/Core>
#include <Eigen/Dense>

#include "Omega.hpp"
#include "autoaim_utilities/Armor.hpp"
#include "autoaim_utilities/KalmanFilter.hpp"
#include "autoaim_utilities/Target.hpp"
#include "autoaim_utilities/Math.hpp"

// auto generated by ros2 generate_parameter_library
// https://github.com/PickNikRobotics/generate_parameter_library
#include <cstdint>
#include <ctime>
#include <fstream>
#include <memory>

#include <energy_predictor/energy_predictor_node_parameters.hpp>
namespace helios_cv
{

enum
{
  INIT = 1,
  STANDBY = 2,
  ESTIMATE = 3,
  PREDICT = 4
};

using tf2_filter = tf2_ros::MessageFilter<autoaim_interfaces::msg::Armors>;
using ParamListener = energy_predictor_node::ParamListener;
using Params = energy_predictor_node::Params;

class EnergyPredictorNode : public rclcpp::Node
{
public:
  EnergyPredictorNode(const rclcpp::NodeOptions& options);

  ~EnergyPredictorNode();

private:
  void reset_observer();

  void track_energy(const autoaim_interfaces::msg::Armor& armors);

  void energy_predictor_callback(autoaim_interfaces::msg::Armors::SharedPtr armors_msg);

  double orientation2roll(const geometry_msgs::msg::Quaternion& orientation);

  bool energy_state_switch();

  Eigen::Vector3d get_energy_center(const autoaim_interfaces::msg::Armor& armor, double yaw);

  void init_kalman();

  // algorithm part
  uint8_t circle_mode_;
  Omega omega_;
  bool isSolve_;
  bool refresh_;
  bool matched_;
  uint8_t ceres_cnt_;
  double pub_time_, pub_omega;
  double a_, w_, phi_, b_;
  int find_state_;
  autoaim_interfaces::msg::Armor tracking_armor_;
  autoaim_interfaces::msg::Armor last_tracking_armor_;
  EigenKalmanFilter omega_kf_;
  double last_roll_ = 0;
  ;
  double dt_;
  int lost_cnt_{};
  int detect_cnt_{};

  int energy_type{}; //1小符，2大符，0无效
  int energy_mode_ = 0;
  double std_dev;

  // time series
  double time_predictor_start_;

  autoaim_interfaces::msg::Target target_msg_;

  rclcpp::Publisher<autoaim_interfaces::msg::Target>::SharedPtr target_pub_;
  rclcpp::Publisher<autoaim_interfaces::msg::Omega>::SharedPtr ceres_pub_;
  rclcpp::Publisher<autoaim_interfaces::msg::DebugEnergyVel>::SharedPtr debug_energy_pub_;
  rclcpp::Subscription<autoaim_interfaces::msg::Omega>::SharedPtr ceres_sub_;
  // tf2
  // Subscriber with tf2 message_filter
  std::shared_ptr<tf2_ros::Buffer> tf2_buffer_;
  std::shared_ptr<tf2_ros::TransformListener> tf2_listener_;
  message_filters::Subscriber<autoaim_interfaces::msg::Armors> armors_sub_;
  std::shared_ptr<tf2_filter> tf2_filter_;

  // Serial info part
  rclcpp::Subscription<autoaim_interfaces::msg::ReceiveData>::SharedPtr serial_sub_;

  // Camera info part
  rclcpp::Subscription<sensor_msgs::msg::CameraInfo>::SharedPtr cam_info_sub_;
  cv::Point2f cam_center_;
  std::shared_ptr<sensor_msgs::msg::CameraInfo> cam_info_;

  // parameter utilities
  std::shared_ptr<ParamListener> param_listener_;
  Params params_;

  // reset predictor service
  uint8_t last_autoaim_mode_ = 0;

  // debug info
  visualization_msgs::msg::Marker position_marker_;
  visualization_msgs::msg::Marker target_energy_marker_;
  visualization_msgs::msg::MarkerArray target_marker_array_;
  rclcpp::Publisher<visualization_msgs::msg::MarkerArray>::SharedPtr target_marker_pub_;
  void get_marker_array(autoaim_interfaces::msg::Target target);
  void create_visualization_markers();
  void check_and_kill_invalid(const autoaim_interfaces::msg::Target& target_msg);

  rclcpp::Logger logger_ = rclcpp::get_logger("EnergyPredictorNode");
};

}  // namespace helios_cv